<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="../bower_components/paper-card/paper-card.html" />
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html" />
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html" />
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html" />

<link rel="import" href="app-data.html">
<link rel="import" href="log-out.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="log-in">
    <template>
        <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
      }
      
      .alert-error {
        background: #ffcdd2;
        border: 1px solid #f44336;
        border-radius: 3px;
        color: #333;
        font-size: 14px;
        padding: 10px;
      }
      a {
        color: #fff;
        font-size: 20px;
        text-decoration: none;
      }
      #logout{
                background: #f44336;
                color: #fff;
                font-weight: bold;
      }
      .reload{
        padding:0;
        border-radius: 5px;
      }
      paper-card{

        @apply(--shadow-none);
      }

    </style>
    <!--Storage Data-->
    <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
    <app-location route="{{route}}"></app-location>
    <app-data key="userData" data="{{storedUser}}"></app-data>

    <!--Dialog Login-->
    <paper-dialog id="modal" with-backdrop class="card">
      <div id="unauthenticated" hidden$="[[storedUser.loggedin]]">
        <h1>Log In</h1>
        <div class="card-content">
        <p><strong>Log in</strong> or <strong>sign up</strong> to Put Points and more POINTS !</p>

        <template is="dom-if" if="[[error]]">
           <p class="alert-error"><strong>Error: [[error]]</strong> </p>
        </template>       
        <!--User Input-->
        <paper-input id="username" 
                     label="User Here" 
                     required auto-validate 
                     error-message="Complete this!" 
                     type="text" value="{{formData.username}}">
                  <iron-icon icon="icons:mail" prefix></iron-icon>
                  <div suffix>@openix.com.ar</div>
                  </paper-icon-button>
        </paper-input>

        <!--Password Input-->
        <paper-input id="password" 
                     label="Password Here" 
                     required auto-validate 
                     error-message="Complete this!" 
                     type="password" value="{{formData.password}}">
                     
        </paper-input>
        
        <iron-a11y-keys id="a11y" 
                        keys="enter"
                        on-keys-pressed="checkForEnter"></iron-a11y-keys>
        <div class="wrapper-btns buttons card-actions">
          
        <paper-button id="btn_login" autofocus 
                        raised class="primary" on-tap="postLogin"
                        disabled$="[[disabled]]">Log In</paper-button>

        <paper-button raised class="link" 
                      dialog-dismiss 
                      on-tap="_cleanData">Cancelar</paper-button>
        </div>
      </div>
      
      </div>
      <div id="authenticated" hidden$="[[!storedUser.loggedin]]">

        <h2>Hello, [[storedUser.name]]!</h2>
        <p>You are currently logged in. You can access <strong>Points</strong>!</p>

        <log-out stored-user="{{storedUser}}">Log Out</log-out>

      </div>
      
    </paper-dialog>
    <paper-dialog id="modalSpinner" modal class="reload card">
        <paper-spinner id="spinner" active></paper-spinner>
    </paper-dialog>
    <iron-ajax id="registerLoginAjax" 
               method="post" 
               content-type="application/x-www-form-urlencoded" 
               handle-as="json" 
               on-response="handleUserResponse"
               on-error="handleUserError"
               last-error="{{error}}"
               ></iron-ajax>
    </template>

    <script>
     Polymer({
      is: 'log-in',
      properties: {
        formData: {
          type: Object,
          value: {
            username:"",
            password:""
          }
        },
        ModelState: Object,
        storedUser: Object,
        errors:[],
        error: Object,
        disabled: true,
        opened:{
          type: Boolean,  
          observer:'_isOpen'
        }
      },
      observers:[
            'nameOrPasswordChange(formData.username,formData.password)'
      ],
      listeners:{
          'modal.iron-overlay-canceled':'_onCloseDialog',
          'logout':'_onLogout'
      },
      //        observers fire //
       _isOpen:function(){
           this.$.modal.open();
      },
      nameOrPasswordChange: function(username,password){
          if(username != null && password !=null){
            if((username.length<1 || password.length<6))
            {this.disabled= true;}
            else
            {this.disabled= false;}    
          }
      },
      //        listeners fire  //
      _onCloseDialog: function(){
        this._cleanData();       
      },
       _onLogout: function () {
          this.$.modal.close();
          this._cleanData();
      },
      //        helpers        //
      _cleanData:function(){
          this.formData = {
            username:"",
            password:""
          };
        this.error=null;
        this.$.username.invalid = false;
        this.$.password.invalid = false;
      },
     _setReqBody: function () {
        var data=JSON.parse(JSON.stringify(this.formData));
        data.grant_type="password";
        data.username=data.username+"@openix.com.ar";
        this.$.registerLoginAjax.body = data;
      },
      //       functions       //
      checkForEnter: function(){
          if(this.$.btn_login.disabled==false){
             this.postLogin();
          }
      },   
      postLogin: function (){
        this.$.modalSpinner.open();
        this.$.modal.close();
        this.$.registerLoginAjax.url = 'http://localhost:2899/Token';
        this._setReqBody();
        this.$.registerLoginAjax.generateRequest();
        
      },
      handleUserResponse: function (event) {
  
        var data = event.detail.__data__.xhr.response;
 
        if(data){
        if (data.access_token) {
          var username = data.userName.split('@',1);
          this.error = '';
          this.storedUser = {
            name: username,
            token: data.access_token,        
            loggedin: true
          };
          this.$.modalSpinner.close();
        }
        }
      },
      handleUserError: function (event) {
        if(this.error){
          if(this.error.response){
            if(this.error.response.error_description){
                this.error =this.error.response.error_description;  
            }
          }else{
          if(this.error.response==null){
            
            this.error="Connection Refused!";
          }
          }
          
        }
        this.$.modalSpinner.close();
        this.$.modal.open();   
       }
    });
  
    </script>
</dom-module>